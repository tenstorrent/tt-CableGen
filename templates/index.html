<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Network Cabling Visualizer</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="icon" type="image/x-icon" href="/static/img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
    <!-- fcose layout for overlap avoidance in hierarchical graphs -->
    <script src="https://unpkg.com/layout-base@2.0.1/layout-base.js"></script>
    <script src="https://unpkg.com/cose-base@2.2.0/cose-base.js"></script>
    <script src="https://unpkg.com/cytoscape-fcose@2.2.0/cytoscape-fcose.js"></script>
    <style>
        /* Prevent browser theming from affecting text readability */
        * {
            color-scheme: light;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            color: #333333;
        }

        /* Mode-specific visibility classes */
        .location-mode-only {
            display: none;
        }

        .hierarchy-mode-only {
            display: none;
        }

        /* When in location mode, show location-only elements */
        body.mode-location .location-mode-only {
            display: block;
        }

        /* When in hierarchy mode, show hierarchy-only elements */
        body.mode-hierarchy .hierarchy-mode-only {
            display: block;
        }

        /* Ensure all text elements have explicit colors */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        p,
        div,
        span,
        label,
        input,
        select,
        button,
        textarea {
            color: inherit;
        }

        /* Force text colors to be explicit and readable */
        .sidebar {
            color: #333333;
        }

        .sidebar * {
            color: inherit;
        }

        .header {
            background-color: #343a40;
            color: white;
            padding: 15px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
        }


        .container {
            display: flex;
            height: calc(100vh - 60px);
        }

        .sidebar {
            width: 350px;
            min-width: 280px;
            background-color: white;
            border-right: 1px solid #dee2e6;
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar h3 {
            margin-top: 0;
            color: #343a40;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }

        /* Tab Navigation Styles */
        .tab-navigation {
            display: flex;
            margin-bottom: 0;
            border-bottom: 2px solid #dee2e6;
            gap: 0;
            background-color: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }

        .tab-button {
            flex: 1;
            padding: 14px 20px;
            background-color: transparent;
            color: #6c757d;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .tab-button:hover {
            background-color: #e9ecef;
            color: #495057;
        }

        .tab-button.active {
            background-color: white;
            color: #007bff;
            border-bottom: 3px solid #007bff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .upload-section {
            background-color: #f8f9fa;
            border: 2px dashed #007bff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            margin-top: 15px;
        }

        .upload-section.dragover {
            background-color: #e3f2fd;
            border-color: #0056b3;
        }

        .mode-badge {
            display: inline-block;
            padding: 3px 9px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        .mode-badge.csv-mode {
            background-color: #d4edda;
            color: #155724;
        }

        .mode-badge.textproto-mode {
            background-color: #cce5ff;
            color: #004085;
        }

        .file-input {
            margin: 10px 0;
        }

        .file-input input[type="file"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
            color: #333333;
        }

        /* Ensure all form elements are readable */
        input,
        select,
        textarea {
            background-color: white !important;
            color: #333333 !important;
            border: 1px solid #ccc !important;
        }

        input::placeholder,
        textarea::placeholder {
            color: #666666 !important;
        }

        .upload-btn {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
        }

        .upload-btn:hover {
            background: #0056b3;
        }

        .upload-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            color: #007bff;
            font-weight: bold;
            margin: 10px 0;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            display: none;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            display: none;
        }

        .range-filter-section {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            color: #333333;
        }

        .range-filter-section * {
            color: #333333;
        }

        .range-filter-section label {
            color: #333333 !important;
            font-weight: bold;
        }

        .info-panel {
            background-color: #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            font-size: 14px;
            line-height: 1.4;
            color: #333333;
        }

        .info-panel * {
            color: #333333 !important;
        }

        /* Collapsible sections */
        .collapsible-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #007bff;
            margin-bottom: 10px;
            transition: background-color 0.2s ease, padding 0.2s ease, margin 0.2s ease;
        }

        .collapsible-header:hover {
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        /* Nested collapsible headers (subsections) should have different hover styling */
        .collapsible-content .collapsible-header {
            padding: 8px 0;
            margin-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .collapsible-content .collapsible-header:hover {
            background-color: #f0f0f0;
            border-radius: 4px;
            padding: 8px 5px;
        }

        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }

        .collapsible-content.expanded {
            max-height: 2000px;
        }

        .collapsible-arrow {
            transition: transform 0.3s ease;
            font-size: 14px;
            color: #007bff;
        }

        .collapsible-arrow.expanded {
            transform: rotate(90deg);
        }

        /* Ensure all text in the sidebar is readable */
        .sidebar h3 {
            color: #343a40 !important;
        }

        .sidebar h4 {
            color: #333333 !important;
        }

        /* Fix any potential dark text on dark background issues */
        .sidebar div,
        .sidebar span,
        .sidebar p {
            color: #333333 !important;
        }

        #cy {
            flex: 1;
            background: white;
            position: relative;
        }

        /* Simple edge label styling - high z-index to ensure above all nodes */
        .cy-edge-label {
            background-color: #ffffff !important;
            border: 2px solid #333333 !important;
            border-radius: 4px !important;
            padding: 3px 6px !important;
            font-size: 11px !important;
            font-weight: bold !important;
            color: #333333 !important;
            z-index: 1500 !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3) !important;
        }

        /* Ensure expand-collapse cue buttons are on top and clickable */
        .cy-expand-collapse-cue,
        [class*="cy-expand-collapse"],
        [class*="expand-collapse-cue"] {
            z-index: 9999 !important;
            pointer-events: auto !important;
            cursor: pointer !important;
        }

        /* Hide cues on tray and port nodes - use more aggressive selectors */
        /* The extension renders cues as SVG elements, so we need to target them via Cytoscape's node data */
        svg g[data-node-type="tray"] [class*="expand-collapse"],
        svg g[data-node-type="port"] [class*="expand-collapse"],
        svg g[class*="cy-node-tray"] [class*="expand-collapse"],
        svg g[class*="cy-node-port"] [class*="expand-collapse"],
        svg g[data-node-type="tray"] g[class*="expand-collapse"],
        svg g[data-node-type="port"] g[class*="expand-collapse"],
        svg g[class*="cy-node-tray"] g[class*="expand-collapse"],
        svg g[class*="cy-node-port"] g[class*="expand-collapse"] {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        /* Alternative: Hide cues based on node ID pattern (if tray nodes have specific IDs) */
        svg g[id*="tray"] [class*="expand-collapse"],
        svg g[id*="port"] [class*="expand-collapse"],
        svg g[id*="tray"] g[class*="expand-collapse"],
        svg g[id*="port"] g[class*="expand-collapse"] {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        /* Hide any SVG groups that look like cues near tray/port nodes */
        svg g[class*="expand-collapse-cue"] {
            pointer-events: auto !important;
        }

        /* But hide them if they're associated with tray/port nodes */
        svg g[data-node-type="tray"]~g[class*="expand-collapse-cue"],
        svg g[data-node-type="port"]~g[class*="expand-collapse-cue"] {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        /* Selected edge labels on top */
        .cy-edge:selected .cy-edge-label {
            z-index: 2500 !important;
            background-color: #ffff99 !important;
            border: 2px solid #ff6600 !important;
            box-shadow: 0 2px 4px rgba(255, 102, 0, 0.4) !important;
        }

        .loading-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-size: 18px;
            color: #666;
        }

        .node-info {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #ff0000;
            border-radius: 8px;
            padding: 15px;
            min-width: 250px;
            max-width: 350px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(255, 0, 0, 0.3);
            color: #000000;
            display: none;
            z-index: 1000;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow: hidden;
        }

        /* Modal overlay for connection placement selection */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            color: #333;
        }

        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .modal-subheader {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
        }

        .placement-option {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .placement-option:hover {
            border-color: #007bff;
            background-color: #f0f8ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
        }

        .placement-option-header {
            margin-bottom: 10px;
        }

        .placement-level-name {
            font-weight: bold;
            font-size: 18px;
            color: #333;
        }

        .placement-instance-highlight {
            margin: 12px 0;
            padding: 10px;
            background: #f0f8ff;
            border-left: 4px solid #007bff;
            border-radius: 4px;
            font-size: 14px;
        }

        .instance-count-badge {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 4px 12px;
            border-radius: 16px;
            font-weight: bold;
            font-size: 15px;
            margin-left: 8px;
        }

        .placement-option-details {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
            margin-top: 10px;
        }

        .modal-footer {
            margin-top: 20px;
            text-align: right;
            border-top: 1px solid #dee2e6;
            padding-top: 15px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.2s ease;
        }

        .modal-btn-primary {
            background: #007bff;
            color: white;
        }

        .modal-btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .modal-btn-secondary {
            background: #6c757d;
            color: white;
        }

        .modal-btn-secondary:hover {
            background: #5a6268;
        }

        /* Physical layout modal form styling */
        .physical-layout-form {
            margin: 20px 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            font-size: 14px;
            color: #333;
            margin-bottom: 5px;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #007bff;
        }

        .form-textarea {
            font-family: monospace;
            resize: vertical;
            min-height: 80px;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            font-size: 12px;
            color: #666;
        }

        .layout-info {
            background: #f0f8ff;
            border-left: 4px solid #007bff;
            padding: 12px;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 14px;
        }

        .layout-info strong {
            color: #007bff;
        }

        /* Responsive design for smaller screens */
        @media (max-width: 1200px) {
            .sidebar {
                width: 300px;
                min-width: 250px;
            }
        }

        @media (max-width: 900px) {
            .sidebar {
                width: 280px;
                min-width: 220px;
                padding: 15px;
            }

            .sidebar h3 {
                font-size: 16px;
            }

            .upload-section {
                padding: 15px;
            }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                min-width: unset;
                height: 300px;
                border-right: none;
                border-bottom: 1px solid #dee2e6;
            }

            #cy {
                height: calc(100vh - 360px);
            }
        }

        /* Notification banner animation */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }

            to {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <!-- Cache refresh reminder splash notification -->
    <div id="cacheRefreshSplash"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 20000; align-items: center; justify-content: center; pointer-events: none;">
        <div
            style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; margin: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.3); text-align: center;">
            <div style="font-size: 48px; margin-bottom: 20px;">üîÑ</div>
            <h2 style="margin: 0 0 15px 0; color: #333; font-size: 24px;">Refresh Recommended</h2>
            <p style="margin: 0 0 25px 0; color: #666; font-size: 16px; line-height: 1.5;">
                To ensure you're viewing the latest version of the site, please perform a hard refresh:
            </p>
            <div
                style="background-color: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 25px; text-align: left;">
                <div style="margin-bottom: 10px; font-weight: 600; color: #333;">Windows/Linux:</div>
                <div style="color: #666; font-family: monospace; font-size: 14px; margin-bottom: 15px;">Ctrl + Shift + R
                </div>
                <div style="margin-bottom: 10px; font-weight: 600; color: #333;">Mac:</div>
                <div style="color: #666; font-family: monospace; font-size: 14px;">Cmd + Shift + R</div>
            </div>
            <button id="cacheRefreshDismiss"
                style="background-color: #007bff; color: white; border: none; border-radius: 6px; padding: 12px 30px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background-color 0.2s;"
                onmouseover="this.style.backgroundColor='#0056b3'" onmouseout="this.style.backgroundColor='#007bff'">
                Got it, thanks!
            </button>
        </div>
    </div>

    <!-- Floating notification banner (fixed at top, below header) -->
    <div id="notificationBanner"
        style="display: none; position: fixed; top: 60px; left: 50%; transform: translateX(-50%); z-index: 10000; min-width: 400px; max-width: 80%; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 8px; padding: 15px 20px; font-size: 14px; font-weight: 500; animation: slideDown 0.3s ease-out;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div id="notificationContent" style="flex: 1; margin-right: 15px;"></div>
            <button id="notificationCloseBtn"
                style="background: none; border: none; font-size: 20px; cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; opacity: 0.7; transition: opacity 0.2s;"
                onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">√ó</button>
        </div>
    </div>

    <div class="header">
        <h1>Network Cabling Visualizer</h1>
    </div>

    <div class="container">
        <div class="sidebar">
            <!-- Initialization Section (shown initially, hidden after initialization) -->
            <div id="initializationSection">
                <h3>Initialize Visualization</h3>

                <!-- Summary Blurb Section -->
                <div id="initializationSummary"
                    style="background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 18px; margin: 20px 0; font-size: 14px; color: #495057; line-height: 1.6;">
                    <p style="margin: 0 0 12px 0; color: #495057;">
                        Use this visualization tool to plan out multi-host system connectivity for Tenstorrent boxes.
                        If you're more interested in the logical hierarchy of the system, use the <strong>Logical
                            Hierarchy</strong> tab.
                        If you're more interested in the physical layout, racking, and arrangement of the system, use
                        the <strong>Physical Deployment</strong> tab.
                    </p>

                    <p
                        style="margin: 0; color: #6c757d; font-size: 13px; padding-top: 12px; border-top: 1px solid #e9ecef;">
                        <strong>Note:</strong> It is easier to work on stamping out hierarchies and templates in
                        <strong>Logical Hierarchy</strong> mode,
                        and then translate that into <strong>Physical Deployment</strong> tab for visualization and rack
                        planning.
                        Working from a cabling guide (starting in <strong>Physical Deployment</strong> mode) and trying
                        to stamp out hierarchies
                        and templates (by switching modes to <strong>Logical Hierarchy</strong> mode) is more difficult.
                    </p>

                    <p
                        style="margin: 12px 0 0 0; color: #495057; font-size: 13px; padding-top: 12px; border-top: 1px solid #e9ecef;">
                        <strong>üìö For more information:</strong> See the complete documentation at
                        <a href="https://docs.tenstorrent.com/tt-CableGen/" target="_blank"
                            style="color: #007bff; text-decoration: underline;">docs.tenstorrent.com/tt-CableGen</a>
                    </p>
                </div>

                <!-- Tab Navigation (no tab selected on startup; both tab contents hidden until user clicks) -->
                <div class="tab-navigation">
                    <button class="tab-button" id="locationTab">
                        üìç Physical Deployment
                        <span class="mode-badge csv-mode">CSV</span>
                    </button>
                    <button class="tab-button" id="topologyTab">
                        üîó Logical Hierarchy
                        <span class="mode-badge textproto-mode">Textproto</span>
                    </button>
                </div>

                <!-- Flow Description Section (changes based on active tab; hidden until a tab is selected) -->
                <div id="flowDescriptionLocation"
                    style="display: none; background-color: #f0f8ff; border: 1px solid #b3d9ff; border-radius: 6px; padding: 15px; margin: 15px 0; font-size: 13px; color: #333;">
                    <h4 style="margin: 0 0 10px 0; color: #0066cc; font-size: 14px;">üìç Location/Deployment Flow</h4>
                    <ul style="margin: 8px 0; padding-left: 25px; line-height: 1.6;">
                        <li><strong>Load CSV:</strong> Import existing cabling data with physical locations (hall,
                            aisle, rack, shelf)</li>
                        <li><strong>Empty Canvas:</strong> Start from scratch and manually add nodes with physical
                            locations</li>
                        <li><strong>Editing:</strong> Good for editing potential rack deployments. Can edit
                            specifc connections and nodes. </li>
                        <li><strong>Exporting:</strong> Good for exporting cabling guide CSV, FactorySystemDescriptor
                            textproto, and DeploymentDescriptor textproto. Not suggested for CablingDescriptor export.
                        </li>
                        <li><strong>Shortcomings:</strong> Not good for visualizing hierarchical network topologies as
                            nested graph instances. (Use Topology Tab for that.) </li>
                    </ul>
                    <p style="margin: 8px 0 0 0; font-size: 12px; color: #666;">
                        <em>Use this mode for physical datacenter layouts organized by rack elevation.</em>
                    </p>
                </div>

                <div id="flowDescriptionTopology"
                    style="display: none; background-color: #fff8f0; border: 1px solid #ffd9b3; border-radius: 6px; padding: 15px; margin: 15px 0; font-size: 13px; color: #333;">
                    <h4 style="margin: 0 0 10px 0; color: #cc6600; font-size: 14px;">üîó Topology Flow</h4>
                    <ul style="margin: 8px 0; padding-left: 25px; line-height: 1.6;">
                        <li><strong>Load Textproto:</strong> Import hierarchical topology with graph templates and
                            instances</li>
                        <li><strong>Empty Canvas:</strong> Start from scratch and manually define logical topology
                            structure</li>
                        <li><strong>Editing:</strong> Good for editing/duplicating potential logical topologies with
                            templates. Can edit templated definitions of connections and nodes. </li>
                        <li><strong>Exporting:</strong> Good for exporting CablingDescriptor textproto. Can switch mode
                            to Location to be able to visualize/edit/export Deployment resources (CablingGuide CSV,
                            FactorySystemDescriptor textproto, and DeploymentDescriptor textproto) </li>
                        <li><strong>Shortcomings:</strong> Not good for visualizing physical datacenter layouts
                            organized by rack elevation. (Use Location Tab for that.) </li>
                    </ul>
                    <p style="margin: 8px 0 0 0; font-size: 12px; color: #666;">
                        <em>Use this mode for logical network topologies organized by hierarchy (clusters, superpods,
                            pods).</em>
                    </p>
                </div>

                <!-- Physical Deployment Tab Content -->
                <div class="tab-content" id="locationTabContent">
                    <div class="upload-section" id="uploadSectionLocation">
                        <div>üìÅ Drag & drop your CSV file here</div>
                        <div style="margin: 10px 0; color: #666;">or</div>

                        <div class="file-input">
                            <input type="file" id="csvFileLocation" accept=".csv" />
                        </div>

                        <p style="font-size: 14px; color: #6c757d; margin-top: 10px;">
                            <strong>Accepts:</strong> CSV files with cabling/deployment data<br>
                            <strong>Purpose:</strong> Load complete physical topology from CSV (good for rack-elevation
                            visualization)
                        </p>

                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="upload-btn" id="uploadBtnLocation" style="flex: 1;">
                                üìä Load CSV
                            </button>
                            <button class="upload-btn" id="emptyVisualizationBtnLocation"
                                style="flex: 1; background: #28a745;">
                                üìã Empty Canvas
                            </button>
                        </div>

                        <div class="loading" id="loadingLocation">
                            üîÑ Processing file...
                        </div>

                        <div class="error" id="errorLocation"></div>
                        <div class="success" id="successLocation"></div>
                    </div>
                </div>

                <!-- Logical Hierarchy Tab Content -->
                <div class="tab-content" id="topologyTabContent">
                    <div class="upload-section" id="uploadSectionTopology">
                        <div>üìÅ Drag & drop your textproto file here</div>
                        <div style="margin: 10px 0; color: #666;">or</div>

                        <div class="file-input">
                            <input type="file" id="csvFileTopology" accept=".textproto" />
                        </div>

                        <p style="font-size: 14px; color: #6c757d; margin-top: 10px;">
                            <strong>Accepts:</strong> Textproto cabling descriptor files
                            <strong>Notes:</strong> Useful for visualizing hierarchical network topologies as nested
                            graph instances.<br>
                        </p>

                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="upload-btn" id="uploadBtnTopology" style="flex: 1;">
                                üìä Load Textproto
                            </button>
                            <button class="upload-btn" id="emptyVisualizationBtnTopology"
                                style="flex: 1; background: #28a745;">
                                üìã Empty Canvas
                            </button>
                        </div>

                        <div class="loading" id="loadingTopology">
                            üîÑ Processing textproto and generating visualization...
                        </div>

                        <div class="error" id="errorTopology"></div>
                        <div class="success" id="successTopology"></div>
                    </div>
                </div>
            </div>
            <!-- End of Initialization Section -->

            <!-- Control Sections (hidden initially, shown after initialization) -->
            <div id="controlSections" style="display: none;">

                <div class="info-panel">
                    <div class="location-mode-only">
                        <strong>üìñ Physical Deployment Mode</strong><br>
                        <p style="margin: 8px 0; line-height: 1.6;">
                            This mode organizes nodes by their physical data center location (hall ‚Üí aisle ‚Üí rack ‚Üí
                            shelf).
                            Use this mode for visualizing racking, planning physical cable routing, and working with CSV
                            files.
                        </p>
                        <p style="margin: 8px 0; line-height: 1.6;">
                            <strong>See <a href="https://docs.tenstorrent.com/tt-CableGen/README-LOCATION.md"
                                    target="_blank"
                                    style="color: #007bff; text-decoration: underline;">README-LOCATION.md</a> for more
                                detailed usage information.</strong>
                        </p>
                    </div>

                    <div class="hierarchy-mode-only">
                        <strong>üìñ Logical Hierarchy Mode</strong><br>
                        <p style="margin: 8px 0; line-height: 1.6;">
                            This mode organizes nodes by their logical topology structure (graph templates ‚Üí instances ‚Üí
                            shelves).
                            Use this mode for designing topology templates, understanding logical groupings, and working
                            with TextProto files.
                        </p>
                        <p style="margin: 8px 0; line-height: 1.6;">
                            <strong>See <a href="https://docs.tenstorrent.com/tt-CableGen/README-HIERARCHY.md"
                                    target="_blank"
                                    style="color: #007bff; text-decoration: underline;">README-HIERARCHY.md</a> for more
                                detailed usage information.</strong>
                        </p>
                    </div>
                </div>

                <!-- Add another cabling guide (location mode only, persists so multiple guides can be imported) -->
                <div id="addAnotherCablingGuideSection" class="location-mode-only"
                    style="margin-bottom: 20px; padding: 15px; background-color: #f0f8ff; border: 2px dashed #007bff; border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">‚ûï Add another cabling guide</h4>
                    <p style="margin: 0 0 10px 0; font-size: 12px; color: #666;">
                        Drag a CSV here or choose a file to merge into the current visualization.
                    </p>
                    <div class="file-input" style="margin: 10px 0;">
                        <input type="file" id="addAnotherCablingGuideFile" accept=".csv" />
                    </div>
                    <button type="button" id="addAnotherCablingGuideBtn" class="upload-btn"
                        style="width: 100%; padding: 10px; font-size: 14px;">
                        üìä Add CSV to visualization
                    </button>
                    <div class="loading" id="loadingAddAnotherLocation" style="margin-top: 8px;">üîÑ Processing...</div>
                </div>

                <!-- Visualization Mode Indicator with Toggle -->
                <div id="visualizationModeIndicator"
                    style="display: none; margin: 15px 0; padding: 12px; border-radius: 6px; background: #e7f3ff; border: 2px solid #2196F3;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <strong style="color: #1976D2; font-size: 14px;">üìä Visualization Mode</strong>
                            <div id="currentMode" style="font-size: 13px; color: #333; margin-top: 4px;">
                                Loading...
                            </div>
                        </div>
                        <div>
                            <button id="toggleModeButton"
                                style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: bold;">
                                Switch Mode
                            </button>
                        </div>
                    </div>
                    <div id="modeDescription"
                        style="font-size: 11px; color: #666; margin-top: 8px; padding-top: 8px; border-top: 1px solid #bbdefb;">
                        Mode information will appear here
                    </div>
                </div>

                <div id="connectionLegend"
                    style="margin-bottom: 20px; padding: 10px; background-color: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6;">
                    <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">Connection Types Legend</h4>
                    <!-- CSV-based legend (default) - dynamically generated for location mode -->
                    <div id="csvLegend">
                        <!-- Legend will be populated dynamically by updateConnectionLegend() -->
                    </div>
                    <!-- Descriptor-based legend (hidden by default) -->
                    <div id="descriptorLegend" style="display: none;">
                        <div style="display: flex; align-items: center; margin: 6px 0;">
                            <div
                                style="width: 20px; height: 3px; background-color: #FF6B6B; margin-right: 10px; border-radius: 2px;">
                            </div>
                            <span style="font-size: 13px; color: #333;">Cluster level (inter-superpod)</span>
                        </div>
                        <div style="display: flex; align-items: center; margin: 6px 0;">
                            <div
                                style="width: 20px; height: 3px; background-color: #4ECDC4; margin-right: 10px; border-radius: 2px;">
                            </div>
                            <span style="font-size: 13px; color: #333;">Superpod level (intra-superpod)</span>
                        </div>
                        <div style="display: flex; align-items: center; margin: 6px 0;">
                            <div
                                style="width: 20px; height: 3px; background-color: #95E1D3; margin-right: 10px; border-radius: 2px;">
                            </div>
                            <span style="font-size: 13px; color: #333;">Deeper hierarchy level 1</span>
                        </div>
                        <div style="display: flex; align-items: center; margin: 6px 0;">
                            <div
                                style="width: 20px; height: 3px; background-color: #FFA07A; margin-right: 10px; border-radius: 2px;">
                            </div>
                            <span style="font-size: 13px; color: #333;">Deeper hierarchy level 2</span>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <button id="resetLayoutBtn"
                        style="width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">
                        üîÑ Reset Layout
                    </button>
                    <div style="font-size: 11px; color: #666; margin-top: 5px; text-align: center;">
                        Recalculate all node positions with consistent spacing
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">Compound Node Controls</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <button id="expandOneLevelBtn"
                            style="padding: 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: bold;">
                            ‚ûï Expand One Level
                        </button>
                        <button id="collapseOneLevelBtn"
                            style="padding: 10px; background: #ffc107; color: #333; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: bold;">
                            ‚ûñ Collapse One Level
                        </button>
                    </div>
                    <div style="font-size: 11px; color: #666; margin-top: 5px; text-align: center;">
                        Step through hierarchy levels. Double-click nodes to collapse/expand individually.
                    </div>
                </div>

                <div class="collapsible-header" data-section="connectionRangeFilter">
                    <h3 style="margin: 0; color: #333;">Connection Options </h3>
                    <span class="collapsible-arrow collapsed" id="connectionRangeFilter-arrow">‚ñ∂</span>
                </div>
                <div class="collapsible-content collapsed" id="connectionRangeFilter">
                    <div class="range-filter-section">
                        <div class="location-mode-only" style="margin-bottom: 15px;">
                            <div style="font-weight: bold; margin-bottom: 8px; color: #333333;">Connection Types:</div>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <label style="display: flex; align-items: center; cursor: pointer; color: #333333;">
                                    <input type="checkbox" id="showSameHostIdConnections" checked
                                        style="margin-right: 8px; transform: scale(1.1);">
                                    <span style="font-size: 14px;">Same host connections</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer; color: #333333;">
                                    <input type="checkbox" id="showSameRackConnections" checked
                                        style="margin-right: 8px; transform: scale(1.1);">
                                    <span style="font-size: 14px;">Same rack connections (different host)</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer; color: #333333;">
                                    <input type="checkbox" id="showSameAisleConnections" checked
                                        style="margin-right: 8px; transform: scale(1.1);">
                                    <span style="font-size: 14px;">Same aisle connections (different rack)</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer; color: #333333;">
                                    <input type="checkbox" id="showSameHallConnections" checked
                                        style="margin-right: 8px; transform: scale(1.1);">
                                    <span style="font-size: 14px;">Same hall connections (different aisle)</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer; color: #333333;">
                                    <input type="checkbox" id="showDifferentHallConnections" checked
                                        style="margin-right: 8px; transform: scale(1.1);">
                                    <span style="font-size: 14px;">Different hall connections</span>
                                </label>
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label for="nodeFilterSelect"
                                style="display: block; margin-bottom: 5px; font-weight: bold; color: #333333;">Filter by
                                Node:</label>
                            <select id="nodeFilterSelect"
                                style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; background-color: white; color: #333333;">
                                <option value="">Show all nodes</option>
                            </select>
                            <div style="font-size: 11px; color: #666; margin-top: 3px;">
                                Select a specific node to show only its connections
                            </div>
                        </div>

                        <div id="destinationFilterContainer" style="margin-bottom: 15px; display: none;">
                            <label for="destinationFilterSelect"
                                style="display: block; margin-bottom: 5px; font-weight: bold; color: #333333;">Filter by
                                Destination:</label>
                            <select id="destinationFilterSelect"
                                style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; background-color: white; color: #333333;">
                                <option value="">Show all destinations</option>
                            </select>
                            <div style="font-size: 11px; color: #666; margin-top: 3px;">
                                Select a destination node to filter connections from the selected source node
                            </div>
                        </div>

                        <div class="hierarchy-mode-only" style="margin-bottom: 15px;">
                            <label for="templateFilterSelect"
                                style="display: block; margin-bottom: 5px; font-weight: bold; color: #333333;">Filter by
                                Template:</label>
                            <select id="templateFilterSelect"
                                style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; background-color: white; color: #333333;">
                                <option value="">Show all templates</option>
                            </select>
                            <div style="font-size: 11px; color: #666; margin-top: 3px;">
                                Select a template to show only its connections
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label for="curveMagnitudeSlider"
                                style="display: block; margin-bottom: 5px; font-weight: bold; color: #333333;">Curve
                                Magnitude:</label>
                            <input type="range" id="curveMagnitudeSlider" min="0" max="4.0" step="0.1" value="1.0"
                                style="width: 100%; height: 6px; border-radius: 3px; background: #ddd; outline: none; cursor: pointer;">
                            <div
                                style="display: flex; justify-content: space-between; font-size: 11px; color: #666; margin-top: 3px;">
                                <span>Flat (0x)</span>
                                <span id="curveMagnitudeValue" style="font-weight: bold; color: #333;">1.0x</span>
                                <span>High (4.0x)</span>
                            </div>
                            <div style="font-size: 11px; color: #666; margin-top: 3px;">
                                Adjust curve strength for all connections
                            </div>
                        </div>

                        <div id="rangeStatus"
                            style="font-size: 12px; color: #666; text-align: center; margin-top: 10px;">
                            Showing all connections
                        </div>

                        <div style="margin-top: 15px; text-align: center;">
                            <button id="resetFiltersBtn"
                                style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: bold;">
                                üîÑ Reset Filters
                            </button>
                        </div>
                    </div>
                </div>

                <div class="collapsible-header" data-section="cablingEditor">
                    <h3 style="margin: 0; color: #333;">Cabling Editor</h3>
                    <span class="collapsible-arrow collapsed" id="cablingEditor-arrow">‚ñ∂</span>
                </div>
                <div class="collapsible-content collapsed" id="cablingEditor">
                    <div style="margin-bottom: 15px;">
                        <button id="toggleEdgeHandlesBtn"
                            style="width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">
                            üîó Enable Cabling Editing
                        </button>
                        <div style="font-size: 11px; color: #666; margin-top: 5px; text-align: center;">
                            Click ports to create connections (2-click process)<br>
                            <span style="color: #cc0000;">‚ö†Ô∏è Each port can only have one connection</span>
                        </div>
                    </div>

                    <div
                        style="margin-bottom: 15px; padding: 10px; background-color: #f0f8ff; border-left: 3px solid #0066cc; border-radius: 4px;">
                        <div style="font-size: 12px; color: #333; font-weight: bold; margin-bottom: 5px;">
                            ‚úèÔ∏è Node Properties Editing:
                        </div>
                        <div style="font-size: 11px; color: #555;">
                            Right-click on any node to edit its properties (hostname, location, etc.)
                        </div>
                    </div>

                    <div id="deleteElementSection" style="margin-bottom: 15px; display: none;">
                        <button id="deleteElementBtn" disabled
                            style="width: 100%; padding: 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; opacity: 0.5;">
                            üóëÔ∏è Delete Selected Element(s)
                        </button>
                        <div style="font-size: 11px; color: #666; margin-top: 5px; text-align: center;">
                            Select connections or nodes (shelf, rack, or graph) to delete, then click to delete
                            (or
                            press Backspace/Delete).<br>
                            Use Shift+Click to select multiple items.<br>
                            Compound nodes will delete all children.
                        </div>
                    </div>

                    <div id="addNodeSection"
                        style="margin-bottom: 20px; border-top: 1px solid #ddd; padding-top: 15px; display: none;">
                        <div class="collapsible-header" data-section="addNodeSubsection"
                            style="cursor: pointer; padding: 8px 0; margin-bottom: 10px; border-bottom: 1px solid #dee2e6;">
                            <h4 style="margin: 0; color: #333; display: inline-block;">Add New Node</h4>
                            <span class="collapsible-arrow collapsed" id="addNodeSubsection-arrow"
                                style="float: right; margin-top: 4px;">‚ñ∂</span>
                        </div>
                        <div class="collapsible-content collapsed" id="addNodeSubsection">

                            <div style="margin-bottom: 10px;">
                                <label for="nodeTypeSelect"
                                    style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Node
                                    Type:</label>
                                <select id="nodeTypeSelect"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: white;">
                                    <optgroup label="N300 LB">
                                        <option value="N300_LB">N300_LB (4 trays, 2 ports each)</option>
                                    </optgroup>
                                    <optgroup label="N300 QB">
                                        <option value="N300_QB">N300_QB (4 trays, 2 ports each)</option>
                                    </optgroup>
                                    <optgroup label="Wormhole Galaxy">
                                        <option value="WH_GALAXY">WH_GALAXY (4 trays, 6 ports each)</option>
                                    </optgroup>
                                    <optgroup label="Blackhole Galaxy">
                                        <option value="BH_GALAXY">BH_GALAXY (4 trays, 14 ports each)</option>
                                    </optgroup>
                                    <optgroup label="P150 QB">
                                        <option value="P150_QB_GLOBAL">P150_QB_GLOBAL (4 trays, 4 ports each)</option>
                                        <option value="P150_QB_AMERICA">P150_QB_AMERICA (4 trays, 4 ports each)</option>
                                        <option value="P150_QB_AE">P150_QB_AE (4 trays, 4 ports each)</option>
                                    </optgroup>
                                    <optgroup label="P150 LB">
                                        <option value="P150_LB">P150_LB (8 trays, 4 ports each)</option>
                                    </optgroup>
                                    <optgroup label="P300 QB">
                                        <option value="P300_QB_GE">P300_QB_GE (2 trays, WARP400)</option>
                                    </optgroup>
                                </select>
                            </div>

                            <!-- Variation radio buttons (shown only for node types that support variations) -->
                            <div id="nodeVariationSection" style="margin-bottom: 10px; display: none;">
                                <label
                                    style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Variation:</label>
                                <div id="nodeVariationRadioGroup"
                                    style="display: flex; flex-wrap: wrap; gap: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                                    <label
                                        style="display: flex; align-items: center; cursor: pointer; font-size: 13px;">
                                        <input type="radio" name="nodeVariation" value="" checked
                                            style="margin-right: 6px;">
                                        <span>None (Base)</span>
                                    </label>
                                    <label id="variationDefault"
                                        style="display: none; align-items: center; cursor: pointer; font-size: 13px;">
                                        <input type="radio" name="nodeVariation" value="_DEFAULT"
                                            style="margin-right: 6px;">
                                        <span>DEFAULT (with QSFP connections)</span>
                                    </label>
                                    <label id="variationXTorus"
                                        style="display: none; align-items: center; cursor: pointer; font-size: 13px;">
                                        <input type="radio" name="nodeVariation" value="_X_TORUS"
                                            style="margin-right: 6px;">
                                        <span>X_TORUS</span>
                                    </label>
                                    <label id="variationYTorus"
                                        style="display: none; align-items: center; cursor: pointer; font-size: 13px;">
                                        <input type="radio" name="nodeVariation" value="_Y_TORUS"
                                            style="margin-right: 6px;">
                                        <span>Y_TORUS</span>
                                    </label>
                                    <label id="variationXYTorus"
                                        style="display: none; align-items: center; cursor: pointer; font-size: 13px;">
                                        <input type="radio" name="nodeVariation" value="_XY_TORUS"
                                            style="margin-right: 6px;">
                                        <span>XY_TORUS</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Physical location fields (only shown in physical view) -->
                            <div id="nodePhysicalFields" style="margin-bottom: 10px;">
                                <div style="margin-bottom: 10px;">
                                    <label for="nodeHostnameInput"
                                        style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Hostname:</label>
                                    <input type="text" id="nodeHostnameInput" placeholder="e.g., new-node-01"
                                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                                </div>

                                <div style="margin-bottom: 10px; border-top: 1px solid #eee; padding-top: 10px;">
                                    <div style="font-weight: bold; color: #555; margin-bottom: 8px;">Location
                                        Information
                                        (Alternative to Hostname):</div>

                                    <div style="display: flex; gap: 10px; margin-bottom: 8px;">
                                        <div style="flex: 1;">
                                            <label for="nodeHallInput"
                                                style="display: block; margin-bottom: 3px; font-size: 12px; color: #666;">Hall:</label>
                                            <input type="text" id="nodeHallInput" placeholder="e.g., Hall1"
                                                style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px; box-sizing: border-box;">
                                        </div>
                                        <div style="flex: 1;">
                                            <label for="nodeAisleInput"
                                                style="display: block; margin-bottom: 3px; font-size: 12px; color: #666;">Aisle:</label>
                                            <input type="text" id="nodeAisleInput" placeholder="e.g., A"
                                                style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px; box-sizing: border-box;">
                                        </div>
                                    </div>

                                    <div style="display: flex; gap: 10px; margin-bottom: 8px;">
                                        <div style="flex: 1;">
                                            <label for="nodeRackInput"
                                                style="display: block; margin-bottom: 3px; font-size: 12px; color: #666;">Rack:</label>
                                            <input type="number" id="nodeRackInput" placeholder="e.g., 1" min="1"
                                                style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px; box-sizing: border-box;">
                                        </div>
                                        <div style="flex: 1;">
                                            <label for="nodeShelfUInput"
                                                style="display: block; margin-bottom: 3px; font-size: 12px; color: #666;">Shelf
                                                U:</label>
                                            <input type="number" id="nodeShelfUInput" placeholder="e.g., 1" min="1"
                                                style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px; box-sizing: border-box;">
                                        </div>
                                    </div>

                                    <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                        <strong>Note:</strong> Either fill out Hostname OR all location fields (Hall,
                                        Aisle,
                                        Rack,
                                        Shelf U)
                                    </div>
                                </div>
                            </div>

                            <!-- Logical view message (only shown in logical view) -->
                            <div id="nodeLogicalMessage"
                                style="display: none; margin-bottom: 10px; padding: 10px; background-color: #e7f3ff; border-radius: 4px; font-size: 13px; color: #0066cc;">
                                <strong>Logical Hierarchy Mode:</strong><br>
                                Node will be auto-named (node_0, node_1, etc.) and added to:<br>
                                ‚Ä¢ Selected graph container (if one is selected)<br>
                                ‚Ä¢ Synthetic root (if no container is selected)<br>
                                No physical location needed.
                            </div>

                            <button id="addNodeBtn" disabled
                                style="width: 100%; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: not-allowed; font-size: 14px; font-weight: bold; opacity: 0.6;">
                                ‚ûï Add Node
                            </button>
                            <div style="font-size: 11px; color: #666; margin-top: 5px; text-align: center;">
                                Upload a visualization first to enable node creation
                            </div>
                        </div>
                    </div>

                    <div id="addGraphSection"
                        style="margin-bottom: 20px; border-top: 1px solid #ddd; padding-top: 15px; display: none;">
                        <div class="collapsible-header" data-section="addGraphSubsection"
                            style="cursor: pointer; padding: 8px 0; margin-bottom: 10px; border-bottom: 1px solid #dee2e6;">
                            <h4 style="margin: 0; color: #333; display: inline-block;">Add Graph Template Instance</h4>
                            <span class="collapsible-arrow collapsed" id="addGraphSubsection-arrow"
                                style="float: right; margin-top: 4px;">‚ñ∂</span>
                        </div>
                        <div class="collapsible-content collapsed" id="addGraphSubsection">

                            <div style="margin-bottom: 10px;">
                                <label for="graphTemplateSelect"
                                    style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Select
                                    Graph
                                    Template:</label>
                                <select id="graphTemplateSelect"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: white;">
                                    <option value="" disabled selected>Select a template to instantiate...</option>
                                </select>
                                <div style="font-size: 11px; color: #666; margin-top: 3px;">
                                    Templates are loaded from imported textproto files
                                </div>
                            </div>

                            <!-- Instance names are now auto-generated as {template_name}_{index} -->
                            <div style="margin-bottom: 10px; display: none;">
                                <label for="graphLabelInput"
                                    style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Instance
                                    Label:</label>
                                <input type="text" id="graphLabelInput"
                                    placeholder="e.g., superpod1, pod_a, cluster_west"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                                <div style="font-size: 11px; color: #666; margin-top: 3px;">
                                    This will be the display name for the graph instance
                                </div>
                            </div>

                            <div
                                style="margin-bottom: 10px; padding: 10px; background-color: #e7f3ff; border-left: 3px solid #2196F3; border-radius: 4px;">
                                <div style="font-size: 12px; color: #555;">
                                    <strong>Auto-naming:</strong> Instances are automatically named as
                                    <code>{template_name}_{index}</code>
                                    <br>
                                    <span style="font-size: 11px; color: #666;">Example: n300_lb_superpod_0,
                                        n300_lb_superpod_1, etc.</span>
                                </div>
                            </div>

                            <button id="addGraphBtn" disabled
                                style="width: 100%; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: not-allowed; font-size: 14px; font-weight: bold; opacity: 0.6;">
                                ‚ûï Add Graph Instance
                            </button>
                            <div style="font-size: 11px; color: #666; margin-top: 5px; text-align: center;">
                                Load a textproto with graph templates to enable
                            </div>
                        </div>
                    </div>

                    <div id="createTemplateSection"
                        style="margin-bottom: 20px; border-top: 1px solid #ddd; padding-top: 15px; display: none;">
                        <div class="collapsible-header" data-section="createTemplateSubsection"
                            style="cursor: pointer; padding: 8px 0; margin-bottom: 10px; border-bottom: 1px solid #dee2e6;">
                            <h4 style="margin: 0; color: #333; display: inline-block;">Create New Template</h4>
                            <span class="collapsible-arrow collapsed" id="createTemplateSubsection-arrow"
                                style="float: right; margin-top: 4px;">‚ñ∂</span>
                        </div>
                        <div class="collapsible-content collapsed" id="createTemplateSubsection">
                            <div style="margin-bottom: 10px;">
                                <label for="newTemplateNameInput"
                                    style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">New
                                    Template Name:</label>
                                <input type="text" id="newTemplateNameInput" placeholder="e.g., my_pod, custom_cluster"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                                <div style="font-size: 11px; color: #666; margin-top: 3px;">
                                    Creates an empty template and adds an instance
                                </div>
                            </div>

                            <button id="createTemplateBtn"
                                style="width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">
                                ‚ú® Create Empty Template
                            </button>
                        </div>
                    </div>
                </div>



                <div class="collapsible-header" data-section="exportOptions">
                    <h3 style="margin: 0; color: #333;">Export Options</h3>
                    <span class="collapsible-arrow collapsed" id="exportOptions-arrow">‚ñ∂</span>
                </div>
                <div class="collapsible-content collapsed" id="exportOptions">
                    <div class="export-section">
                        <div style="margin-bottom: 15px;">
                            <label for="exportFileNameInput"
                                style="display: block; margin-bottom: 5px; font-weight: bold; color: #333333;">Export
                                Prefix:</label>
                            <input type="text" id="exportFileNameInput" placeholder="e.g., my_network_topology"
                                style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; font-family: monospace; background-color: white; color: #333333;">
                            <div style="font-size: 11px; color: #666; margin-top: 3px;">
                                Prefix applied to textproto filenames. Leave empty for default names
                                (cabling_descriptor.textproto, deployment_descriptor.textproto)
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;" id="exportCablingDescriptorSection">
                            <button id="exportCablingBtn"
                                style="width: 100%; padding: 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">
                                üìÑ Export CablingDescriptor
                            </button>
                            <div style="font-size: 11px; color: #666; margin-top: 5px; text-align: center;">
                                Download textproto file with cabling topology
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;" id="exportDeploymentDescriptorSection"
                            class="location-mode-only">
                            <button id="exportDeploymentBtn"
                                style="width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">
                                üèóÔ∏è Export DeploymentDescriptor
                            </button>
                            <div style="font-size: 11px; color: #666; margin-top: 5px; text-align: center;">
                                Download textproto file with node deployment info
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;" id="generateCablingGuideSection" class="location-mode-only">
                            <button id="generateCablingGuideBtn"
                                style="width: 100%; padding: 12px; background: #6f42c1; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">
                                üìä Generate Cabling Guide
                            </button>
                            <div style="font-size: 11px; color: #666; margin-top: 5px; text-align: center;">
                                Generate CablingGuide CSV file
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;" id="generateFSDSection" class="location-mode-only">
                            <button id="generateFSDBtn"
                                style="width: 100%; padding: 12px; background: #fd7e14; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">
                                üè≠ Generate FSD
                            </button>
                            <div style="font-size: 11px; color: #666; margin-top: 5px; text-align: center;">
                                Generate Factory System Descriptor textproto file
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <!-- End of Control Sections -->
        </div>

        <div id="cy">
            <div class="loading-overlay" id="cyLoading">
                <div>üöÄ Ready to visualize your network cabling!</div>
                <div style="font-size: 14px; color: #999; margin-top: 10px;">Drag and drop a file anywhere, or select a
                    tab and upload a file or create an
                    empty canvas to get started</div>
            </div>
        </div>

        <div class="node-info" id="nodeInfo">
            <div id="nodeInfoContent"></div>
        </div>

        <!-- Modal for connection placement level selection -->
        <div class="modal-overlay" id="connectionPlacementModal">
            <div class="modal-content">
                <div class="modal-header">Choose Connection Placement Level</div>
                <div class="modal-subheader">
                    Select where to define this connection. Template-level connections are created in all instances of
                    that template. Instance-specific connections create a single connection with full paths.
                </div>
                <div id="placementOptionsContainer">
                    <!-- Placement options will be dynamically inserted here -->
                </div>
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-secondary" id="cancelConnectionPlacementBtn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Modal for physical layout specification and paste destination (reused) -->
        <div class="modal-overlay" id="physicalLayoutModal">
            <div class="modal-content">
                <div class="modal-header" id="physicalLayoutModalHeader">üìç Specify Physical Layout</div>
                <div class="modal-subheader" id="physicalLayoutModalSubheader">
                    Choose how to assign physical locations to all nodes: upload a deployment descriptor or define
                    ranges manually.
                </div>

                <!-- Tab selection for manual vs upload (hidden when modal used for paste destination) -->
                <div id="physicalLayoutModalTabs"
                    style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd;">
                    <button class="layout-tab-btn active" id="manualLayoutTab"
                        style="flex: 1; padding: 10px; background: none; border: none; border-bottom: 3px solid #007bff; cursor: pointer; font-weight: bold;">
                        üìù Manual Entry
                    </button>
                    <button class="layout-tab-btn" id="uploadLayoutTab"
                        style="flex: 1; padding: 10px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer;">
                        üìÅ Upload Deployment Descriptor
                    </button>
                </div>

                <!-- Manual entry form (shared by physical layout and paste destination) -->
                <div id="manualLayoutContent" class="layout-tab-content">
                    <!-- Hierarchy paste: parent graph and instance name (hidden when location paste or physical layout) -->
                    <div class="physical-layout-form" id="physicalLayoutHierarchyPasteGroup" style="display: none;">
                        <div class="form-group">
                            <label for="hierarchyPasteParentId">Paste under (parent graph):</label>
                            <select id="hierarchyPasteParentId" class="form-input">
                                <option value="">‚Äî Root (top level) ‚Äî</option>
                            </select>
                            <small>Select a graph instance as parent, or paste at root.</small>
                        </div>
                        <div class="form-group">
                            <label for="hierarchyPasteInstancePrefix">Instance name prefix (optional):</label>
                            <input type="text" id="hierarchyPasteInstancePrefix" class="form-input" value="copy"
                                placeholder="e.g. copy, my_cluster">
                            <small>Used for root-level graph instance names (e.g. copy_0, copy_1).</small>
                        </div>
                    </div>
                    <div class="physical-layout-form">
                        <div class="form-group" id="physicalLayoutHallGroup">
                            <label for="hallNames">Hall Names (optional):</label>
                            <textarea id="hallNames" rows="2" class="form-input form-textarea"
                                placeholder='e.g., Building-A, West-Wing. Default: "DataHall". Clear to omit hall level.'>DataHall</textarea>
                            <small>Comma-separated list or one per line. Default: "DataHall". Clear this field to omit
                                the hall level.</small>
                        </div>
                        <div class="form-group" id="physicalLayoutAisleGroup">
                            <label for="aisleNames">Aisle Names (optional):</label>
                            <input type="text" id="aisleNames" class="form-input" value="A"
                                placeholder="e.g., A, B, C (leave empty to omit)">
                            <small>Comma-separated list or number (e.g., 5 for A-E). Leave empty to omit aisle
                                level.</small>
                        </div>
                        <div class="form-group" id="physicalLayoutRackGroup">
                            <label for="rackNumbers">Rack Numbers:</label>
                            <input type="text" id="rackNumbers" class="form-input" value="1-10"
                                placeholder="e.g., 1-10 or 1,2,5,10,15">
                            <small>Range (e.g., 1-10) or comma-separated (e.g., 1, 2, 5, 10, 15)</small>
                        </div>
                        <div class="form-group" id="physicalLayoutShelfUsGroup">
                            <label for="shelfUnitNumbers">Shelf U Numbers:</label>
                            <input type="text" id="shelfUnitNumbers" class="form-input" value="24,18,12,6"
                                placeholder="e.g., 1-42 or 1,2,3,5,10">
                            <small>Range (e.g., 1-42) or comma-separated (e.g., 1, 2, 3, 5, 10)</small>
                        </div>
                        <div class="layout-info" id="physicalLayoutCapacityRow">
                            <strong>Total Capacity:</strong> <span id="totalCapacity">42 nodes</span>
                        </div>
                    </div>
                </div>

                <!-- Deployment descriptor upload form -->
                <div id="uploadLayoutContent" class="layout-tab-content" style="display: none;">
                    <div class="physical-layout-form">
                        <div class="form-group">
                            <label for="deploymentDescriptorFile">Deployment Descriptor File:</label>
                            <input type="file" id="deploymentDescriptorFile" class="form-input" accept=".textproto">
                            <small>Upload a deployment descriptor (.textproto) that matches the host_id indices from
                                your cabling descriptor</small>
                        </div>
                        <div class="layout-info"
                            style="background: #fff3cd; border-color: #ffc107; padding: 15px; border-radius: 5px; margin-top: 15px;">
                            <strong>‚ö†Ô∏è Important:</strong> The deployment descriptor must match your cabling descriptor
                            by index.<br>
                            <strong>Example:</strong> If cabling descriptor has host=0 for "node_alpha", then
                            deployment descriptor's hosts[0] should contain "node_alpha" with its physical location.
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="modal-btn modal-btn-secondary" id="cancelPhysicalLayoutModalBtn">Cancel</button>
                    <button class="modal-btn modal-btn-primary" id="applyLayoutBtn">Apply Layout</button>
                    <button class="modal-btn modal-btn-primary" id="applyUploadBtn" style="display: none;">Upload &
                        Apply</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Server-side injected node configurations
        // This ensures JavaScript always uses the same configs as Python
        window.SERVER_NODE_CONFIGS = {{ node_configs | tojson }};

        // Preserve URL parameters through OAuth2 redirects
        // Store current URL parameters if they exist, so they can be restored after OAuth2 redirect
        (function () {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const fileParam = urlParams.get('file') || urlParams.get('url');

                // If we have file/url parameter, store it in sessionStorage
                // This helps preserve it through OAuth2 redirects
                if (fileParam) {
                    const currentUrl = window.location.pathname + window.location.search;
                    sessionStorage.setItem('preserved_url_params', currentUrl);
                    console.log('Stored URL parameters for OAuth2 redirect:', currentUrl);
                }

                // Check if we need to restore URL parameters after OAuth2 redirect
                const preservedParams = sessionStorage.getItem('preserved_url_params');
                if (preservedParams && !fileParam && preservedParams.includes('file=')) {
                    // We were redirected back but lost the parameters - restore them
                    console.log('Restoring preserved URL parameters:', preservedParams);
                    const preservedUrl = new URL(preservedParams, window.location.origin);
                    window.history.replaceState({}, '', preservedUrl.pathname + preservedUrl.search);
                    // Reload to trigger the file loading
                    // Only reload once to prevent infinite loop
                    const reloaded = sessionStorage.getItem('url_params_reloaded');
                    if (!reloaded) {
                        sessionStorage.setItem('url_params_reloaded', 'true');
                        window.location.reload();
                        return;
                    } else {
                        // Clear the flag after successful restore
                        sessionStorage.removeItem('url_params_reloaded');
                    }
                }
            } catch (e) {
                console.warn('Could not preserve URL parameters:', e);
            }
        })();

        // Cache busting: Check if we need to force a reload or show refresh reminder
        // This helps users with cached HTML get the latest version
        (function () {
            try {
                const currentVersion = '{{ cache_version }}';
                const storedVersion = sessionStorage.getItem('page_version');
                const splashDismissed = sessionStorage.getItem('cache_refresh_splash_dismissed');

                // Function to show the cache refresh splash
                function showCacheRefreshSplash() {
                    const splash = document.getElementById('cacheRefreshSplash');
                    if (splash) {
                        splash.style.display = 'flex';
                        splash.style.pointerEvents = 'auto';
                        splash.style.animation = 'fadeIn 0.3s ease-out';
                    }
                }

                // Function to dismiss the splash
                function dismissSplash() {
                    const splash = document.getElementById('cacheRefreshSplash');
                    if (splash) {
                        splash.style.animation = 'fadeOut 0.3s ease-out';
                        splash.style.pointerEvents = 'none';
                        setTimeout(() => {
                            splash.style.display = 'none';
                        }, 300);
                        sessionStorage.setItem('cache_refresh_splash_dismissed', 'true');
                    }
                }

                // Set up dismiss button
                const dismissBtn = document.getElementById('cacheRefreshDismiss');
                if (dismissBtn) {
                    dismissBtn.addEventListener('click', dismissSplash);
                }

                // Allow clicking outside the modal to dismiss
                const splash = document.getElementById('cacheRefreshSplash');
                if (splash) {
                    splash.addEventListener('click', function (e) {
                        // Only dismiss if clicking the backdrop (not the modal content)
                        if (e.target === splash) {
                            dismissSplash();
                        }
                    });
                }

                // If versions don't match, we're likely viewing a cached page
                if (storedVersion && storedVersion !== currentVersion) {
                    console.log('Page version mismatch detected. Forcing hard reload to clear cache...');
                    sessionStorage.setItem('page_version', currentVersion);
                    // Force a hard reload to bypass cache
                    window.location.reload(true);
                    return;
                }

                // Show splash on first load of the session to remind users about hard refresh
                // Only show if it hasn't been dismissed in this session
                if (!splashDismissed) {
                    // Show splash after a short delay to let page load
                    setTimeout(() => {
                        showCacheRefreshSplash();
                    }, 500);
                }

                // Store current version for next page load comparison
                if (currentVersion) {
                    sessionStorage.setItem('page_version', currentVersion);
                }
            } catch (e) {
                // Silently fail if sessionStorage is not available
                console.warn('Could not check page version:', e);
            }
        })();
    </script>
    <script type="module" src="{{ url_for('static', filename='js/visualizer.js', v=cache_version) }}"></script>
    <!-- All inline script functions have been moved to visualizer.js (Phase 10.5) -->
</body>

</html>